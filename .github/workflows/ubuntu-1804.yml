name: Ubuntu 18.04 continuous test suite

on:
  push:
    branches:
      - develop

jobs:
  
  build-and-test:
    name: Test on Ubuntu 18.04
    runs-on: ubuntu-18.04
    
    steps:
    - name: checkout repository
      uses: actions/checkout@v2

    - name: install dependencies
      run: |
        echo 'deb http://www.cs.ox.ac.uk/chaste/ubuntu bionic/' | sudo tee -a /etc/apt/sources.list.d/chaste.list
        sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 422C4D99
        sudo apt update
        sudo apt install chaste-dependencies

    - name: make build directory
      run: mkdir chaste-build-dir

    - name: cmake configure
      run: cmake -DCMAKE_BUILD_TYPE=Debug ..
      working-directory: chaste-build-dir

    - name: build core libraries
      run: cmake --build . --parallel 2 --target chaste_core
      working-directory: chaste-build-dir

    - name: build cell_based
      run: cmake --build . --parallel 2 --target chaste_cell_based
      working-directory: chaste-build-dir

    - name: build crypt
      run: cmake --build . --parallel 2 --target chaste_crypt
      working-directory: chaste-build-dir

    - name: build heart
      run: cmake --build . --parallel 2 --target chaste_heart
      working-directory: chaste-build-dir

    - name: build lung
      run: cmake --build . --parallel 2 --target chaste_lung
      working-directory: chaste-build-dir

    - name: build continuous test pack
      run: cmake --build . --parallel 2 --target Continuous
      working-directory: chaste-build-dir

    - name: build nightly test pack
      run: cmake --build . --parallel 2 --target Nightly
      working-directory: chaste-build-dir

    - name: run Continuous test pack
      run: ctest -j2 -L Continuous --output-on-failure
      working-directory: chaste-build-dir

    - name: run Nightly test pack
      run: ctest -j2 -L Nightly --output-on-failure
      working-directory: chaste-build-dir
